{"version":3,"file":"object.js","sources":["../../src/flash/object.ts"],"sourcesContent":["import { tracked } from '@glimmer/tracking';\nimport { guidFor } from '@ember/object/internals';\nimport { cancel, later, type Timer } from '@ember/runloop';\nimport { destroy, isDestroyed, registerDestructor } from '@ember/destroyable';\nimport { isTesting, macroCondition } from '@embroider/macros';\n\nimport type { SafeString } from '@ember/template';\n\n// Disable timeout by default when running tests (backward compatible behavior)\nconst defaultDisableTimeout = macroCondition(isTesting()) ? true : false;\n\nexport type Message = string | SafeString;\n\ninterface FlashService<T extends Record<string, unknown>> {\n  queue?: FlashObject<T>[];\n  removeFromGuidSet?(guid: string): void;\n}\n\nexport type FlashObjectOptions<\n  T extends Record<string, unknown> = Record<string, unknown>,\n> = {\n  message?: Message;\n  type?: string;\n  priority?: number;\n  timeout?: number;\n  extendedTimeout?: number;\n  sticky?: boolean;\n  showProgress?: boolean;\n  destroyOnClick?: boolean;\n  preventDuplicates?: boolean;\n  testHelperDisableTimeout?: boolean;\n  flashService?: FlashService<T>;\n  onDestroy?: () => void;\n  onDidDestroyMessage?: () => void;\n  onDidExitMessage?: () => void;\n} & T;\n\nconst INTERNAL_KEYS = new Set([\n  // Lifecycle callbacks â€” already assigned to `this` above the loop, but\n  // listed here as a safety net in case future refactors change that order.\n  'onDestroy',\n  'onDidDestroyMessage',\n  'onDidExitMessage',\n  // Options consumed by the constructor but not stored as class properties.\n  'testHelperDisableTimeout',\n  // Stored in a private field (#flashService), so `key in this` won't catch it.\n  'flashService',\n]);\n\nexport default class FlashObject<\n  T extends Record<string, unknown> = Record<string, unknown>,\n> {\n  // Static property for test helper to control timeout behavior\n  // Defaults to true in test environment via @embroider/macros\n  static isTimeoutDisabled = defaultDisableTimeout;\n\n  // Note: Custom properties from T are copied at runtime in constructor\n  // TypeScript sees them via FlashObject<T> & T intersection in service/component\n\n  @tracked exiting = false;\n\n  // Core properties with defaults (message is tracked for reactivity)\n  @tracked message: Message;\n  type: string;\n  priority: number;\n  timeout: number;\n  extendedTimeout: number;\n  sticky: boolean;\n  showProgress: boolean;\n  destroyOnClick: boolean;\n  preventDuplicates: boolean;\n\n  // Internal state\n  #isExitable = true;\n  #initializedTime = 0;\n  #timerTask?: Timer;\n  #exitTask?: Timer;\n  #flashService?: FlashService<T>;\n\n  // Callbacks (settable from outside for tests)\n  onDestroy?: () => void;\n  onDidDestroyMessage?: () => void;\n  onDidExitMessage?: () => void;\n\n  get _guid() {\n    const msg = this.message;\n    // Handle SafeString (has toHTML) vs regular string\n    const msgString =\n      typeof msg === 'object' && msg !== null ? msg.toHTML() : String(msg);\n    return guidFor(msgString);\n  }\n\n  constructor(options: FlashObjectOptions<T>) {\n    // Set defaults, then override with options\n    this.message = options.message ?? '';\n    this.type = options.type ?? 'info';\n    this.priority = options.priority ?? 100;\n    // Only use default timeout when explicitly provided in options\n    this.timeout = options.timeout ?? 0;\n    this.extendedTimeout = options.extendedTimeout ?? 0;\n    this.sticky = options.sticky ?? false;\n    this.showProgress = options.showProgress ?? false;\n    this.destroyOnClick = options.destroyOnClick ?? true;\n    this.preventDuplicates = options.preventDuplicates ?? false;\n\n    // Store service reference and callbacks\n    this.#flashService = options.flashService;\n    this.onDestroy = options.onDestroy;\n    this.onDidDestroyMessage = options.onDidDestroyMessage;\n    this.onDidExitMessage = options.onDidExitMessage;\n\n    // Copy any custom properties from T\n    for (const [key, value] of Object.entries(options)) {\n      if (!(key in this) && !INTERNAL_KEYS.has(key)) {\n        (this as Record<string, unknown>)[key] = value;\n      }\n    }\n\n    // Check if timeout should be disabled (static property set by test helpers)\n    const shouldDisableTimeout =\n      options.testHelperDisableTimeout ?? FlashObject.isTimeoutDisabled;\n\n    registerDestructor(this, () => {\n      this.onDestroy?.();\n      this.#cancelAllTimers();\n    });\n\n    if (!shouldDisableTimeout && !this.sticky && this.timeout > 0) {\n      this.#startTimer();\n      this.#initializedTime = Date.now();\n    }\n  }\n\n  /** Destroy this flash message immediately, triggering exit animation. */\n  destroyMessage() {\n    this.#cancelAllTimers();\n    this.#timerTask = undefined;\n    this.#exitTask = undefined;\n\n    this.#startExitTimer();\n  }\n\n  /** Trigger the exit flow (respects isExitable). */\n  exitMessage() {\n    if (!this.#isExitable) return;\n\n    this.#startExitTimer();\n    this.onDidExitMessage?.();\n  }\n\n  /** Prevent the message from exiting (e.g., on mouse enter). */\n  preventExit() {\n    this.#isExitable = false;\n  }\n\n  /** Allow the message to exit again (e.g., on mouse leave). */\n  allowExit() {\n    this.#isExitable = true;\n    this.#checkIfShouldExit();\n  }\n\n  /** Pause the auto-dismiss timer. */\n  pauseTimer() {\n    if (this.#timerTask) {\n      // eslint-disable-next-line ember/no-runloop\n      cancel(this.#timerTask);\n      this.#timerTask = undefined;\n    }\n  }\n\n  /** Resume the auto-dismiss timer with remaining time. */\n  resumeTimer() {\n    if (this.sticky || this.exiting || this.#timerTask) return;\n\n    const elapsed = Date.now() - this.#initializedTime;\n    const remaining = this.timeout - elapsed;\n\n    if (remaining > 0) {\n      // eslint-disable-next-line ember/no-runloop\n      this.#timerTask = later(() => {\n        this.#timerTask = undefined;\n        this.exitMessage();\n      }, remaining);\n    } else {\n      this.exitMessage();\n    }\n  }\n\n  // Expose for component to check\n  get isExitable() {\n    return this.#isExitable;\n  }\n\n  // Expose for testing\n  get timerTaskInstance() {\n    return this.#timerTask;\n  }\n\n  #startTimer() {\n    if (!this.timeout) return;\n\n    // eslint-disable-next-line ember/no-runloop\n    this.#timerTask = later(() => {\n      this.#timerTask = undefined;\n      this.exitMessage();\n    }, this.timeout);\n  }\n\n  #startExitTimer() {\n    if (isDestroyed(this)) return;\n\n    this.exiting = true;\n\n    if (this.extendedTimeout) {\n      // eslint-disable-next-line ember/no-runloop\n      this.#exitTask = later(() => this.#teardown(), this.extendedTimeout);\n    } else {\n      this.#teardown();\n    }\n  }\n\n  #cancelAllTimers() {\n    // eslint-disable-next-line ember/no-runloop\n    if (this.#timerTask) cancel(this.#timerTask);\n    // eslint-disable-next-line ember/no-runloop\n    if (this.#exitTask) cancel(this.#exitTask);\n  }\n\n  #checkIfShouldExit() {\n    const elapsed = Date.now() - this.#initializedTime;\n    if (elapsed >= this.timeout && !this.sticky) {\n      this.#cancelAllTimers();\n      this.exitMessage();\n    }\n  }\n\n  #teardown() {\n    const guid = this._guid;\n\n    // Remove from service queue\n    if (this.#flashService?.queue) {\n      this.#flashService.queue = this.#flashService.queue.filter(\n        (flash) => flash !== this,\n      );\n    }\n\n    // Remove from guid set for duplicate tracking\n    this.#flashService?.removeFromGuidSet?.(guid);\n\n    destroy(this);\n    this.onDidDestroyMessage?.();\n  }\n}\n"],"names":["defaultDisableTimeout","macroCondition","isTesting","INTERNAL_KEYS","Set","FlashObject","isTimeoutDisabled","g","prototype","tracked","i","type","priority","timeout","extendedTimeout","sticky","showProgress","destroyOnClick","preventDuplicates","onDestroy","onDidDestroyMessage","onDidExitMessage","_guid","msg","message","msgString","toHTML","String","guidFor","constructor","options","flashService","key","value","Object","entries","has","shouldDisableTimeout","testHelperDisableTimeout","registerDestructor","Date","now","destroyMessage","undefined","exitMessage","preventExit","allowExit","pauseTimer","cancel","resumeTimer","exiting","elapsed","remaining","later","isExitable","timerTaskInstance","#startTimer","#startExitTimer","isDestroyed","#cancelAllTimers","#checkIfShouldExit","#teardown","guid","queue","filter","flash","removeFromGuidSet","destroy"],"mappings":"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"}