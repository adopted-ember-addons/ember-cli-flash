{"version":3,"file":"flash-messages.js","sources":["../../src/services/flash-messages.ts"],"sourcesContent":["import Service from '@ember/service';\nimport { tracked } from '@glimmer/tracking';\nimport { assert, warn } from '@ember/debug';\nimport {\n  registerDestructor,\n  associateDestroyableChild,\n} from '@ember/destroyable';\n\nimport FlashMessage from '../flash/object.ts';\n\nimport type { FlashObjectOptions, Message } from '../flash/object.ts';\nimport type Owner from '@ember/owner';\n\ntype FlashMessageDefaults = {\n  timeout: number;\n  extendedTimeout: number;\n  priority: number;\n  sticky: boolean;\n  showProgress: boolean;\n  type: string;\n  types: string[];\n  preventDuplicates: boolean;\n  destroyOnClick: boolean;\n};\n\ntype FlashMessageOptions<\n  T extends Record<string, unknown> = Record<string, unknown>,\n> = Partial<FlashMessageDefaults> & {\n  message?: Message;\n  onDestroy?: () => void;\n  onDidDestroyMessage?: () => void;\n  onDidExitMessage?: () => void;\n  testHelperDisableTimeout?: boolean;\n} & T;\n\ntype FlashMessageInstance<\n  T extends Record<string, unknown> = Record<string, unknown>,\n> = FlashMessage<T> &\n  T & {\n    _guid: string;\n    priority: number;\n    message: Message;\n    type: string;\n    preventDuplicates: boolean;\n  };\n\ntype FlashTypeFunction<\n  T extends Record<string, unknown> = Record<string, unknown>,\n> = (\n  message: Message,\n  options?: FlashMessageOptions<T>,\n) => FlashMessagesService<T>;\n\nconst DEFAULT_FLASH_MESSAGE_OPTIONS: FlashMessageDefaults = {\n  timeout: 3000,\n  extendedTimeout: 0,\n  priority: 100,\n  sticky: false,\n  showProgress: false,\n  type: 'info',\n  types: ['success', 'info', 'warning', 'danger', 'alert', 'secondary'],\n  preventDuplicates: false,\n  destroyOnClick: true,\n};\n\nexport default class FlashMessagesService<\n  T extends Record<string, unknown> = Record<string, unknown>,\n> extends Service {\n  @tracked queue: FlashMessageInstance<T>[] = [];\n\n  // Set for O(1) duplicate checking\n  #guidSet = new Set<string>();\n\n  // Default message type methods (registered dynamically)\n  declare success: FlashTypeFunction<T>;\n  declare info: FlashTypeFunction<T>;\n  declare warning: FlashTypeFunction<T>;\n  declare danger: FlashTypeFunction<T>;\n  declare alert: FlashTypeFunction<T>;\n  declare secondary: FlashTypeFunction<T>;\n\n  // Index signature for dynamically registered types\n  [key: string]: unknown;\n\n  get arrangedQueue() {\n    return this.queue.slice().sort((a, b) => b.priority - a.priority);\n  }\n\n  get isEmpty() {\n    return this.queue.length === 0;\n  }\n\n  // Backward-compatible getters for default properties (used by tests)\n  get defaultTimeout() {\n    return this.flashMessageDefaults.timeout;\n  }\n\n  get defaultExtendedTimeout() {\n    return this.flashMessageDefaults.extendedTimeout;\n  }\n\n  get defaultPriority() {\n    return this.flashMessageDefaults.priority;\n  }\n\n  get defaultSticky() {\n    return this.flashMessageDefaults.sticky;\n  }\n\n  get defaultShowProgress() {\n    return this.flashMessageDefaults.showProgress;\n  }\n\n  get defaultType() {\n    return this.flashMessageDefaults.type;\n  }\n\n  get defaultTypes() {\n    return this.flashMessageDefaults.types;\n  }\n\n  get defaultPreventDuplicates() {\n    return (\n      this.#overridePreventDuplicates ??\n      this.flashMessageDefaults.preventDuplicates\n    );\n  }\n\n  set defaultPreventDuplicates(value: boolean) {\n    // Allow tests to override default preventDuplicates\n    this.#overridePreventDuplicates = value;\n  }\n\n  // Override storage for tests\n  #overridePreventDuplicates?: boolean;\n\n  /**\n   * For backward compatibility - returns array of message guids\n   */\n  get _guids() {\n    return [...this.#guidSet];\n  }\n\n  constructor(owner: Owner) {\n    super(owner);\n\n    // Register default types\n    this.registerTypes(this.flashMessageDefaults.types);\n\n    registerDestructor(this, () => {\n      this.clearMessages();\n    });\n  }\n\n  /** Add a flash message to the queue. Returns the service for chaining. */\n  add(options: FlashMessageOptions<T> = {} as FlashMessageOptions<T>): this {\n    const flashInstance = this.#createFlashMessage(options);\n    this.#enqueue(flashInstance);\n    return this;\n  }\n\n  /** Clear all flash messages from the queue. */\n  clearMessages(): this | void {\n    if (!this.queue) {\n      return;\n    }\n\n    this.queue.forEach((flash) => flash.destroyMessage());\n    this.queue = [];\n    this.#guidSet.clear();\n\n    return this;\n  }\n\n  /** Register custom flash message types (e.g., 'custom' creates service.custom()). */\n  registerTypes(types: string[] = []): this {\n    types.forEach((type) => this.#registerType(type));\n    return this;\n  }\n\n  /** Get the first flash message in the queue. */\n  peekFirst() {\n    return this.queue[0];\n  }\n\n  /** Get the last flash message in the queue. */\n  peekLast() {\n    return this.queue[this.queue.length - 1];\n  }\n\n  /** Get the last flash message (throws if queue is empty). */\n  getFlashObject() {\n    const errorText = 'A flash message must be added before it can be returned';\n    assert(errorText, this.queue.length);\n    return this.peekLast() as FlashMessageInstance<T>;\n  }\n\n  /**\n   * Find a flash message by a custom field (e.g., 'id').\n   */\n  findBy<K extends keyof FlashMessageInstance<T>>(\n    key: K,\n    value: FlashMessageInstance<T>[K],\n  ): FlashMessageInstance<T> | undefined {\n    return this.queue.find((flash) => flash[key] === value);\n  }\n\n  /**\n   * Remove a flash message by a custom field (e.g., 'id').\n   */\n  removeBy<K extends keyof FlashMessageInstance<T>>(\n    key: K,\n    value: FlashMessageInstance<T>[K],\n  ): boolean {\n    const message = this.findBy(key, value);\n    if (message) {\n      // Remove from queue immediately so the message disappears from the UI\n      // without waiting for the extendedTimeout exit-animation delay.\n      // destroyMessage() still handles timer cleanup and destroyable teardown.\n      this.queue = this.queue.filter((flash) => flash !== message);\n      this.#guidSet.delete(message._guid);\n      message.destroyMessage();\n      return true;\n    }\n    return false;\n  }\n\n  /**\n   * Override this getter to customize defaults:\n   *\n   * ```typescript\n   * export default class MyFlashMessages extends FlashMessagesService {\n   *   get flashMessageDefaults() {\n   *     return { ...super.flashMessageDefaults, timeout: 5000 };\n   *   }\n   * }\n   * ```\n   */\n  get flashMessageDefaults() {\n    return DEFAULT_FLASH_MESSAGE_OPTIONS;\n  }\n\n  #createFlashMessage(\n    options: FlashMessageOptions<T>,\n  ): FlashMessageInstance<T> {\n    const defaults = this.flashMessageDefaults;\n    const preventDuplicates =\n      options.preventDuplicates ??\n      this.#overridePreventDuplicates ??\n      defaults.preventDuplicates;\n\n    assert(\n      'The flash message cannot be empty when preventDuplicates is enabled.',\n      !preventDuplicates || options.message,\n    );\n\n    // Merge defaults with options using spread (simple and clean)\n    const flashOptions: FlashObjectOptions<T> = {\n      timeout: defaults.timeout,\n      extendedTimeout: defaults.extendedTimeout,\n      priority: defaults.priority,\n      sticky: defaults.sticky,\n      showProgress: defaults.showProgress,\n      type: defaults.type,\n      destroyOnClick: defaults.destroyOnClick,\n      preventDuplicates, // Use calculated value, not defaults\n      ...options,\n      flashService: this,\n    } as FlashObjectOptions<T>;\n\n    const message = new FlashMessage<T>(flashOptions);\n    associateDestroyableChild(this, message);\n    return message as FlashMessageInstance<T>;\n  }\n\n  #registerType(type: string) {\n    assert('The flash type cannot be undefined', type);\n\n    (this as Record<string, FlashTypeFunction<T>>)[type] = (\n      message,\n      options = {} as FlashMessageOptions<T>,\n    ) => this.add({ ...options, message, type });\n  }\n\n  #enqueue(flashInstance: FlashMessageInstance<T>) {\n    const preventDuplicates =\n      flashInstance.preventDuplicates ??\n      this.#overridePreventDuplicates ??\n      this.flashMessageDefaults.preventDuplicates;\n\n    const guid = flashInstance._guid;\n\n    if (preventDuplicates && this.#guidSet.has(guid)) {\n      warn(\n        'Attempting to add a duplicate message to the Flash Messages Service',\n        false,\n        { id: 'ember-cli-flash.duplicate-message' },\n      );\n      return;\n    }\n\n    // Always track guid for _guids getter\n    this.#guidSet.add(guid);\n    this.queue = [...this.queue, flashInstance];\n  }\n\n  /**\n   * Called by FlashObject when it's destroyed to remove from guid set\n   */\n  removeFromGuidSet(guid: string) {\n    this.#guidSet.delete(guid);\n  }\n}\n"],"names":["DEFAULT_FLASH_MESSAGE_OPTIONS","timeout","extendedTimeout","priority","sticky","showProgress","type","types","preventDuplicates","destroyOnClick","FlashMessagesService","Service","g","prototype","tracked","i","Set","arrangedQueue","queue","slice","sort","a","b","isEmpty","length","defaultTimeout","flashMessageDefaults","defaultExtendedTimeout","defaultPriority","defaultSticky","defaultShowProgress","defaultType","defaultTypes","defaultPreventDuplicates","value","_guids","constructor","owner","registerTypes","registerDestructor","clearMessages","add","options","flashInstance","forEach","flash","destroyMessage","clear","peekFirst","peekLast","getFlashObject","errorText","assert","findBy","key","find","removeBy","message","filter","delete","_guid","#createFlashMessage","defaults","flashOptions","flashService","FlashMessage","associateDestroyableChild","#registerType","#enqueue","guid","has","warn","id","removeFromGuidSet"],"mappings":"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"}